## Methods {#sec:methods}

PhenoPLIER is a framework that combines different computational approaches to integrate gene-trait associations and drug-induced transcriptional responses with groups of functionally-related genes (referred to as gene modules or latent variables/LVs).
Gene-trait associations are computed using the PrediXcan family of methods, whereas latent variables are inferred by the MultiPLIER models applied on large gene expression compendia. 

PhenoPLIER provides:

1) A regression model to compute an LV-trait association.
2) A consensus clustering approach applied to the latent space to learn shared and distinct transcriptomic properties between traits.
3) An interpretable, LV-based drug repurposing framework.

We provide the details of these methods below.

*equation_definition

LV: Latent Variable

*equation_definition

LV-trait association: The association between a latent variable and a specific trait, calculated using a regression model.

*equation_definition

Consensus clustering: A technique used to identify clusters in the latent space that have shared or distinct transcriptomic properties.


### The PrediXcan family of methods for gene-based associations {#sec:methods:predixcan}

We utilized Summary-PrediXcan (S-PrediXcan) (Barbeira et al., 2018) and Summary-MultiXcan (S-MultiXcan) (Barbeira et al., 2019) as the gene-based statistical approaches, which are part of the PrediXcan family of methods (Barbeira et al., 2018).
These approaches are collectively known as TWAS (transcription-wide association studies).
S-PrediXcan, the summary-based version of PrediXcan, calculates the univariate association between a trait and a gene's predicted expression in a single tissue.
On the other hand, S-MultiXcan, the summary-based version of MultiXcan, calculates the joint association between a gene's predicted expression in all tissues and a trait.
S-PrediXcan and S-MultiXcan only require GWAS summary statistics instead of individual-level genotype and phenotype data.

*equation_definition
- S-PrediXcan: Univariate association between a trait and a gene's predicted expression in a single tissue.
- S-MultiXcan: Joint association between a gene's predicted expression in all tissues and a trait.

Here we briefly provide the details about these Transcriptome-Wide Association Study (TWAS) methods that are necessary to explain our regression framework later (see the referenced articles for more information).

*equation_definition*

In the following, we refer to $\mathbf{y}$ as a vector of traits for $n$ individuals that is centered for convenience (so that no intercept is necessary). 

*equation_definition*

where $\tilde{\mathbf{t}}_l = \sum_{a \in \mathrm{model}_l} w_{a}^{l} X_{a}$ is the gene's predicted expression for all individuals in tissue $l$, $X_a$ is the genotype of SNP $a$, and $w_{a}$ is its weight in the tissue prediction model $l$.

*equation_definition*

Moreover, $\mathbf{t}_l$ is the standardized version of $\tilde{\mathbf{t}}_l$ with mean equal to zero and standard deviation equal to one.

S-PrediXcan [@doi:10.1038/s41467-018-03621-1] is a condensed version of PrediXcan [@doi:10.1038/ng.3367], which represents the trait as a linear function of a gene's expression in a single tissue using the univariate model:

$$
\mathbf{y} = \mathbf{t}_l \gamma_l + \bm{\epsilon}_l,
$$

{#eq:predixcan}

where $\hat{\gamma}_l$ is the estimated effect size or regression coefficient, and $\bm{\epsilon}_l$ represents the error terms with variance $\sigma_{\epsilon}^{2}$.
The significance of the association is evaluated by calculating the $z$-score $\hat{z}_{l}=\hat{\gamma}_l / \mathrm{se}(\hat{\gamma}_l)$ for a gene's tissue model $l$.
PrediXcan necessitates individual-level data to fit this model, while S-PrediXcan approximates PrediXcan $z$-scores using only GWAS summary statistics with the expression:

$$
\hat{z}_{l} \approx \sum_{a \in model_{l}} w_a^l \frac{\hat{\sigma}_a}{\hat{\sigma}_l} \frac{\hat{\beta}_a}{\mathrm{se}(\hat{\beta}_a)},
$$

{#eq:spredixcan}

where $\hat{\sigma}_a$ denotes the variance of SNP $a$, $\hat{\sigma}_l$ represents the variance of the predicted expression of a gene in tissue $l$, and $\hat{\beta}_a$ is the estimated effect size of SNP $a$ from the GWAS.
The genotype variances and covariances in these Transcriptome-Wide Association Study (TWAS) methods are estimated using the Genotype-Tissue Expression project (GTEx v8) [@doi:10.1126/science.aaz1776] as the reference panel.
As S-PrediXcan offers tissue-specific direction of effects (e.g., whether a higher or lower predicted expression of a gene confers more or less disease risk), we utilized the $z$-scores in our drug repurposing strategy (explained below).

S-MultiXcan is the summary version of MultiXcan, which is more powerful than PrediXcan in detecting gene-trait associations, although it does not provide the direction of effects.
The main output of MultiXcan is the p-value (obtained with an F-test) of the multiple tissue model:

$$
\begin{split}
\mathbf{y} & = \sum_{l=1}^{p} \mathbf{t}_l g_l + \mathbf{e} \\
& = \mathbf{T} \mathbf{g} + \mathbf{e},
\end{split}
$$

where $\mathbf{T}$ is a matrix with $p$ columns $\mathbf{t}_l$, $\hat{g}_l$ is the estimated effect size for the predicted gene expression in tissue $l$, and $\mathbf{e}$ are the error terms with variance $\sigma_{e}^{2}$.
Due to the high correlation between predicted expression values for a gene across different tissues, MultiXcan uses the principal components (PCs) of $\mathbf{T}$ to avoid collinearity issues.
S-MultiXcan derives the joint regression estimates (effect sizes and their variances) using the marginal estimates from S-PrediXcan.
Under the null hypothesis of no association, $\hat{\mathbf{g}}^{\top} \frac{\mathbf{T}^{\top}\mathbf{T}}{\sigma_{e}^{2}} \hat{\mathbf{g}} \sim \chi_{p}^{2}$, and therefore the significance of the association in S-MultiXcan is estimated with:

$$
\begin{split}
\frac{\hat{\mathbf{g}}^{\top} (\mathbf{T}^{\top}\mathbf{T}) \hat{\mathbf{g}}}{\sigma_{e}^{2}} & \approx \bm{\hat{\gamma}}^{\top} \frac{\sqrt{n-1}}{\sigma_{\epsilon}} \left(\frac{\mathbf{T}^{\top} \mathbf{T}}{n-1}\right)^{-1} \frac{\sqrt{n-1}}{\sigma_{\epsilon}} \bm{\hat{\gamma}} \\
& = \hat{\mathbf{z}}^{\top} Cor(\mathbf{T})^{-1} \hat{\mathbf{z}},
\end{split}
$$

where $\hat{\mathbf{z}}$ is a vector with $p$ z-scores for each tissue available for the gene, and $Cor(\mathbf{T})$ is the autocorrelation matrix of $\mathbf{T}$.
Since $\mathbf{T}^{\top}\mathbf{T}$ is singular for many genes, S-MultiXcan computes the pseudo-inverse $Cor(\mathbf{T})^{+}$ using the $k$ top PCs, and thus $\hat{\mathbf{z}}^{\top} Cor(\mathbf{T})^{+} \hat{\mathbf{z}} \sim \chi_k^2$.
To arrive at this expression, S-MultiXcan uses the conservative approximation $\sigma_{e}^{2} \approx \sigma_{\epsilon}^{2}$.
Another important point is that $Cor(\mathbf{T})$ is estimated using a global genotype covariance matrix, whereas marginal $\hat{z}_l$ are approximated using tissue-specific genotype covariances.
Although S-MultiXcan yields highly concordant estimates compared with MultiXcan, results are not perfectly correlated across genes.
These differences are important for our LV-based regression model when computing the gene-gene correlation matrix.
We used S-MultiXcan results for our LV-based regression model and our cluster analyses of traits.


### TWAS resources {#sec:methods:twas}

We used two large TWAS resources from different cohorts for discovery and replication, all obtained from European ancestries.
PhenomeXcan [@doi:10.1126/sciadv.aba2083], our discovery cohort, provides results on 4,091 traits across different categories.
Supplementary Data 1 has all the details about the included GWAS, sample size and disease/trait categories.
In PhenomeXcan, these publicly available GWAS summary statistics were used to compute
1) gene-based associations with the PrediXcan family of methods (described before), and
2) a posterior probability of colocalization between GWAS loci and *cis*-eQTL with fastENLOC [@doi:10.1126/sciadv.aba2083; @doi:10.1016/j.ajhg.2020.11.012].
We refer to the matrix of $z$-scores from S-PrediXcan (Equation (@eq:spredixcan)) across $q$ traits and $m$ genes in tissue $t$ as $\mathbf{M}^{t} \in \mathbb{R}^{q \times m}$.
As explained later, matrices $\mathbf{M}^{t}$ were used in our LV-based drug repurposing framework since they provide direction of effects.
The S-MultiXcan results (22,515 gene associations across 4,091 traits) were used in our LV-based regression framework and our cluster analyses of traits.
For the cluster analyses, we used the $p$-values converted to $z$-scores: $\mathbf{M}=\Phi^{-1}(1 - p/2)$, where $\Phi^{-1}$ is the probit function.
Higher $z$-scores correspond to stronger associations.

Our discovery cohort was eMERGE [@doi:10.1038/gim.2013.72], where the same TWAS methods were run on 309 phecodes [@doi:10.1101/2021.10.21.21265225] across different categories (more information about traits are available in [@doi:10.1101/2021.10.21.21265225]).
We used these results to replicate the associations found with our LV-based regression framework in PhenomeXcan.


### MultiPLIER and Pathway-level information extractor (PLIER) {#sec:methods:multiplier}

MultiPLIER (Gligorijevic et al., 2019) extracts patterns of co-expressed genes from recount2 (Collado-Torres et al., 2017), a large gene expression dataset.
The approach applies the pathway-level information extractor method (PLIER) (Crowell et al., 2019), which performs unsupervised learning using prior knowledge (canonical pathways) to reduce technical noise.
PLIER uses a matrix factorization approach that deconvolutes gene expression data into a set of latent variables (LV), where each LV represents a gene module.

*equation_definition: LV - Latent Variable

The MultiPLIER models reduced the dimensionality in recount2 to 987 LVs.

Given a gene expression dataset $\mathbf{Y}^{m \times c}$ with $m$ genes and $c$ experimental conditions and a prior knowledge matrix $\mathbf{C} \in \{0,1\}^{m \times p}$ for $p$ MSigDB pathways (so that $\mathbf{C}_{ij} = 1$ if gene $i$ belongs to pathway $j$), PLIER finds $\mathbf{U}$, $\mathbf{Z}$, and $\mathbf{B}$ minimizing

$$
||\mathbf{Y} - \mathbf{Z}\mathbf{B}||^{2}_{F} + \lambda_1 ||\mathbf{Z} - \mathbf{C}\mathbf{U}||^{2}_{F} + \lambda_2 ||\mathbf{B}||^{2}_{F} + \lambda_3 ||\mathbf{U}||_{L^1}
$$ 

{#eq:met:plier_func}

subject to $\mathbf{U}>0, \mathbf{Z}>0$; $\mathbf{Z}^{m \times l}$ are the gene loadings with $l$ latent variables, $\mathbf{B}^{l \times c}$ is the latent space for $c$ conditions, $\mathbf{U}^{p \times l}$ specifies which of the $p$ prior-information pathways in $\mathbf{C}$ are represented for each latent variable, and $\lambda_i$ are different regularization parameters used in the training step.
$\mathbf{Z}$ is a low-dimensional representation of the gene space where each latent variable aligns as much as possible to prior knowledge, and it might represent either a known or novel gene module (i.e., a meaningful biological pattern) or noise. 

*equation_definition

*equation_definition

*equation_definition

For our drug repurposing and cluster analyses, we utilized a model to project gene-trait associations (obtained from TWAS) and gene-drug associations (obtained from LINCS L1000) into a low-dimensional gene module space.
Specifically, TWAS associations $\mathbf{M}$ (derived from either S-PrediXcan or S-MultiXcan) were projected using the following equation:

*equation_definition:
$$
\hat{\mathbf{M}} = (\mathbf{Z}^{\top} \mathbf{Z} + \lambda_{2} \mathbf{I})^{-1} \mathbf{Z}^{\top} \mathbf{M},
$$

Here, $\hat{\mathbf{M}}^{l \times q}$ represents a matrix where traits are depicted by gene modules rather than individual genes.
Subsequently, we applied the same methodology to project drug-induced transcriptional profiles in LINCS L1000, enabling us to characterize drugs using gene modules.


### Regression model for LV-trait associations {#sec:methods:reg}

We adapted the gene-set analysis framework from MAGMA [@doi:10.1371/journal.pcbi.1004219] to TWAS.
We used a competitive test to predict gene-trait associations from TWAS using gene weights from an LV, testing whether top-weighted genes for an LV are more strongly associated with the phenotype than other genes with relatively small or zero weights.
Thus, we fit the model

$$
\mathbf{m}=\beta_{0} + \mathbf{s} \beta_{s} + \sum_{i} \mathbf{x}_{i} \beta_{i} + \bm{\epsilon},
$$ {#eq:reg:model}

where $\mathbf{m}$ is a vector of S-MultiXcan gene $p$-values for a trait (with a $-log_{10}$ transformation); $\mathbf{s}$ is a binary indicator vector with $s_{\ell}=1$ for the top 1% of genes with the largest loadings for latent variable (LV) $\ell$ (from $\mathbf{Z}_{\ell}$) and zero otherwise; $\mathbf{x}_{i}$ is a gene property used as a covariate; $\beta$ are effect sizes (with $\beta_{0}$ as the intercept); and $\bm{\epsilon} \sim \mathrm{MVN}(0, \sigma^{2} \mathbf{R})$ is a vector of error terms with a multivariate normal distribution (MVN) where $\mathbf{R}$ is the matrix of gene correlations.

*equation_definition

$\mathbf{m}$: Vector of S-MultiXcan gene $p$-values for a trait

$\mathbf{s}$: Binary indicator vector

$\mathbf{x}_{i}$: Gene property used as a covariate

$\beta$: Effect sizes

$\bm{\epsilon}$: Vector of error terms

$\mathbf{R}$: Matrix of gene correlations

The model tests the null hypothesis $\beta_{s} = 0$ against the one-sided hypothesis $\beta_{s} > 0$.
Therefore, $\beta_{s}$ reflects the difference in trait associations between genes that are part of latent variable (LV) $\ell$ and genes outside of it.
Following the MAGMA framework, we used two gene properties as covariates:

*equation_definition*
- *gene size*: the number of principal components (PCs) retained in S-MultiXcan
- *gene density*: the ratio of the number of PCs to the number of tissues available

These covariates were utilized to account for potential confounding factors in the analysis.

*equation_definition: Error terms $\bm{\epsilon}$ are correlated, not assuming independent normal distributions as in a standard linear regression model.

*equation_definition: The gene-gene correlation matrix $\mathbf{R}$ is approximated by computing correlations between the model sum of squares (SSM) for each gene pair under the null hypothesis of no association.

*equation_definition: The SSM for each gene is proportional to $\mathbf{y}^{\top} \mathbf{P}_{i} \mathbf{P}_{i}^{\top} \mathbf{y}$ in the MAGMA framework.

*equation_definition: The correlation between the SSMs for genes $i$ and $j$ is given by $\mathbf{R}_{ij} = \frac{2 \times \mathrm{Tr}(\mathbf{P}_{i}^{\top} \mathbf{P}_{j} \mathbf{P}_{j}^{\top} \mathbf{P}_{i})}{\sqrt{2 \times k_{i}} \times \sqrt{2 \times k_{j}} \times (n - 1)^2}$.

*equation_definition: The cross-correlation matrix between PCs is $Cor(\mathbf{P}_{i}, \mathbf{P}_{j}) = \mathrm{diag}(\lambda_i)^{-1/2} \mathbf{V}_{i} (\frac{\mathbf{T}_{i}^{\top} \mathbf{T}_{j}}{n-1}) \mathbf{V}_{j}^{\top} \mathrm{diag}(\lambda_j)^{-1/2}$.

*equation_definition: The correlation of predicted expression levels for genes $i$ in tissue $k$ and gene $j$ in tissue $l$ is given by $\frac{(\mathbf{T}_{i}^{\top} \mathbf{T}_{j})_{kl}}{n-1} = Cor(\mathbf{t}_k^i, \mathbf{t}_l^j) = \frac{ Cov(\sum_{a \in \mathrm{model}_k} w_a^k X_a, \sum_{b \in \mathrm{model}_l} w_b^l X_b) } { \sqrt{\widehat{\mathrm{var}}(\mathbf{t}_k) \widehat{\mathrm{var}}(\mathbf{t}_l)} }$.

*equation_definition: The variance of the predicted expression values of gene $i$ in tissue $k$ is estimated as $\widehat{\mathrm{var}}(\mathbf{t}_k^i) = (\mathbf{W}^k)^\top \Gamma^k \mathbf{W}^k$.

In the PrediXcan family of methods, we utilized a generalized least squares approach to handle correlated error terms $\bm{\epsilon}$, which may not have independent normal distributions as in standard linear regression models.
The gene-gene correlation matrix $\mathbf{R}$ was estimated by calculating correlations between the model sum of squares (SSM) for each gene pair under the null hypothesis of no association.
These correlations were derived from the individual-level MultiXcan model (Equation (@eq:multixcan)), where the predicted expression matrix $\mathbf{T}_{i} \in \mathbb{R}^{n \times p_i}$ of a gene $i$ across $p_i$ tissues is projected into its top $k_i$ principal components (PCs), resulting in matrix $\mathbf{P}_{i} \in \mathbb{R}^{n \times k_i}$.
The SSM for each gene was found to be proportional to $\mathbf{y}^{\top} \mathbf{P}_{i} \mathbf{P}_{i}^{\top} \mathbf{y}$ in the MAGMA framework.
Therefore, under the null hypothesis of no association, the covariance between the SSMs of genes $i$ and $j$ was determined as $2 \times \mathrm{Trace}(\mathbf{P}_{i}^{\top} \mathbf{P}_{j} \mathbf{P}_{j}^{\top} \mathbf{P}_{i})$.
The correlation between the SSMs for genes $i$ and $j$ can be expressed as:

$$
\begin{split}
\mathbf{R}_{ij} & = \frac{2 \times \mathrm{Tr}(\mathbf{P}_{i}^{\top} \mathbf{P}_{j} \mathbf{P}_{j}^{\top} \mathbf{P}_{i})}{\sqrt{2 \times k_{i}} \times \sqrt{2 \times k_{j}} \times (n - 1)^2} \\
& = \frac{2 \times \mathrm{Tr}(Cor(\mathbf{P}_{i}, \mathbf{P}_{j}) \times Cor(\mathbf{P}_{j}, \mathbf{P}_{i}))}{\sqrt{2 \times k_{i}} \times \sqrt{2 \times k_{j}}},
\end{split}
$$ {#eq:reg:r}

Here, the columns of $\mathbf{P}$ are standardized, $\mathrm{Tr}$ represents the trace of a matrix, and the cross-correlation matrix between PCs $Cor(\mathbf{P}_{i}, \mathbf{P}_{j}) \in \mathbb{R}^{k_i \times k_j}$ is given by:

$$
\begin{split}
Cor(\mathbf{P}_{i}, \mathbf{P}_{j}) & = Cor(\mathbf{T}_{i} \mathbf{V}_{i}^{\top} \mathrm{diag}(\lambda_i)^{-1/2}, \mathbf{T}_{j} \mathbf{V}_{j}^{\top} \mathrm{diag}(\lambda_j)^{-1/2}) \\
& = \mathrm{diag}(\lambda_i)^{-1/2} \mathbf{V}_{i} (\frac{\mathbf{T}_{i}^{\top} \mathbf{T}_{j}}{n-1}) \mathbf{V}_{j}^{\top} \mathrm{diag}(\lambda_j)^{-1/2},
\end{split}
$$ {#eq:reg:cor_pp}

where $\frac{\mathbf{T}_{i}^{\top} \mathbf{T}_{j}}{n-1} \in \mathbb{R}^{p_i \times p_j}$ is the cross-correlation matrix between the predicted expression levels of genes $i$ and $j$, and columns of $\mathbf{V}_{i}$ and scalars $\lambda_i$ are the eigenvectors and eigenvalues of $\mathbf{T}_{i}$, respectively.
S-MultiXcan retains only the top eigenvectors using a condition number threshold of $\frac{\max(\lambda_i)}{\lambda_i} < 30$.
To estimate the correlation of predicted expression levels for genes $i$ in tissue $k$ and gene $j$ in tissue $l$, $(\mathbf{t}_k^i, \mathbf{t}_l^j)$ ($\mathbf{t}_k^i$ is the $k$th column of $\mathbf{T}_{i}$), we followed the approach proposed by [@doi:10.1371/journal.pgen.1007889]:

$$
\begin{split}
\frac{(\mathbf{T}_{i}^{\top} \mathbf{T}_{j})_{kl}}{n-1} & = Cor(\mathbf{t}_k^i, \mathbf{t}_l^j) \\
& = \frac{ Cov(\mathbf{t}_k, \mathbf{t}_l) } { \sqrt{\widehat{\mathrm{var}}(\mathbf{t}_k) \widehat{\mathrm{var}}(\mathbf{t}_l)} } \\
& = \frac{ Cov(\sum_{a \in \mathrm{model}_k} w_a^k X_a, \sum_{b \in \mathrm{model}_l} w_b^l X_b) }  {\sqrt{\widehat{\mathrm{var}}(\mathbf{t}_k) \widehat{\mathrm{var}}(\mathbf{t}_l)} } \\
& = \frac{ \sum_{\substack{a \in \mathrm{model}_k \\ b \in \mathrm{model}_l}} w_a^k w_b^l Cov(X_a, X_b)} {\sqrt{\widehat{\mathrm{var}}(\mathbf{t}_k) \widehat{\mathrm{var}}(\mathbf{t}_l)} } \\
& = \frac{ \sum_{\substack{a \in \mathrm{model}_k \\ b \in \mathrm{model}_l}} w_a^k w_b^l \Gamma_{ab}} {\sqrt{\widehat{\mathrm{var}}(\mathbf{t}_k) \widehat{\mathrm{var}}(\mathbf{t}_l)} },
\end{split}
$$ {#eq:reg:corr_genes}

Here, $X_a$ represents the genotype of SNP $a$, $w_a^k$ is the weight of SNP $a$ for gene expression prediction in the tissue model $k$, and $\Gamma = \widehat{\mathrm{var}}(\mathbf{X}) = (\mathbf{X} - \bar{\mathbf{X}})^{\top} (\mathbf{X} - \bar{\mathbf{X}}) / (n-1)$ is the genotype covariance matrix using GTEx v8 as the reference panel, consistent with all TWAS methods described in this study.
The variance of the predicted expression values of gene $i$ in tissue $k$ is estimated as proposed by [@doi:10.1038/s41467-018-03621-1]:

$$
\begin{split}
\widehat{\mathrm{var}}(\mathbf{t}_k^i) & = (\mathbf{W}^k)^\top \Gamma^k \mathbf{W}^k \\
& = \sum_{\substack{a \in \mathrm{model}_k \\ b \in \mathrm{model}_k}} w_a^k w_b^k \Gamma_{ab}^k.
\end{split}
$$ {#eq:reg:var_gene}

Since we utilized the MultiXcan regression model (Equation (1)), $\mathbf{R}$ serves as an approximation of gene correlations in S-MultiXcan.
As previously described, S-MultiXcan approximates the joint regression parameters in MultiXcan by utilizing the marginal regression estimates from S-PrediXcan in Equation (2) with certain simplifying assumptions and distinct genotype covariance matrices.
This complicates the derivation of an S-MultiXcan-specific solution to calculate $\mathbf{R}$.

*equation_definition*

Equation (1): MultiXcan regression model

\[
y = X\beta + \epsilon
\]

*equation_definition*

Equation (2): S-PrediXcan regression model

\[
y = Z\gamma + \epsilon
\]

To address this issue, we opted to use a submatrix $\mathbf{R}_{\ell}$ that corresponds to genes exclusively part of latent variable (LV) $\ell$ (top 1% of genes) instead of the entire matrix $\mathbf{R$.
This simplification is considered conservative since correlations are taken into account for only the top genes.
Our simulations (Supplementary Note 1) demonstrate that the model is reasonably well-calibrated and capable of correcting for LVs with adjacent and highly correlated genes at the top (e.g., Figure 1).
However, the simulation also revealed 127 LVs in which the model was not well-calibrated (e.g., Figure 2).
This discrepancy can be attributed to challenges in accurately computing a gene correlation matrix, leading us to exclude these LVs from our primary analyses.

In Equation (@eq:reg:corr_genes), we only considered tissue models present in S-PrediXcan results and SNPs present in GWAS used for TWAS approaches for each gene to ensure accurate correlation estimates [@doi:10.1371/journal.pgen.1007889].

*equation_definition: Equation (@eq:reg:corr_genes): Correlation matrix computation for genes based on tissue models and SNPs.

Therefore, we computed separate correlation matrices for PhenomeXcan and eMERGE.
In PhenomeXcan, 4,049 GWAS were sourced from the UK Biobank using a consistent pipeline and SNP set, allowing for the use of a single correlation matrix.
For other GWAS, we employed a single correlation matrix for groups of traits with shared or overlapping SNPs.

We ran our regression model for all 987 LVs across the 4,091 traits in PhenomeXcan.
For replication, we ran the model in the 309 phecodes in eMERGE.
We adjusted the $p$-values using the Benjamini-Hochberg procedure.


### LV-based drug repurposing approach {#sec:methods:drug}

For the drug-disease prediction, we developed an LV-based method within a drug repositioning framework previously utilized for psychiatry traits (Gandal et al., 2018), in which individual genes associated with a trait exhibit an inverse relationship with the expression profiles of drugs.
To evaluate our LV-based method, we compared it with the single-gene approach described in a study by Chen et al.
(2018).
In the single-gene method, a drug-disease score was computed by multiplying each S-PrediXcan set of signed $z$-scores in tissue $t$, denoted as $\mathbf{M}^t$, with another set of signed $z$-scores from transcriptional responses obtained from LINCS L1000 (Subramanian et al., 2017), represented as $\mathbf{L}^{c \times m}$ (for $c$ compounds).
Here, $\mathbf{M}^t$ provides information on whether a higher or lower predicted expression of a gene is linked to disease risk, while $\mathbf{L}$ indicates whether a drug elevates or diminishes the expression of a gene.
These two matrices can be multiplied to calculate a score for a drug-disease pair.
The resulting product is defined as $\mathbf{D}^{t,k}=-1 \cdot \mathbf{M}^{t,k} \mathbf{L}^\top$, where $k$ denotes the number of most significant gene associations in $\mathbf{M}^t$ for each trait.
As recommended by Gandal et al.
(2018), $k$ could encompass all genes or the top 50, 100, 250, or 500; subsequently, we computed the average score ranks across all $k$ to obtain $\mathbf{D}^t$.
Ultimately, for each drug-disease pair, we selected the maximum prediction score across all tissues: $\mathbf{D}_{ij} = \max \{ \mathbf{D}_{ij}^t \mid \forall t \}$.


The same procedure was utilized for the Latent Variable (LV)-based approach, in which we projected matrix $\mathbf{M}^{t}$ and matrix $\mathbf{L}$ into the gene module latent space using Equation (@eq:proj).
This projection resulted in $\hat{\mathbf{M}}^t$ and $\hat{\mathbf{L}}^{l \times c}$, respectively.
Subsequently, we calculated $\mathbf{D}^{t,k}=-1 \cdot \hat{\mathbf{L}}^{\top} \hat{\mathbf{M}}^{t,k}$, where $k$ could represent all LVs or the top 5, 10, 25, and 50 (given that we have approximately ten times fewer LVs than genes).

*equation_definition
- $\mathbf{M}^{t}$: Matrix representing gene expression patterns for trait $t$
- $\mathbf{L}$: Matrix representing gene co-expression patterns
- $\hat{\mathbf{M}}^t$: Projected matrix of gene expression patterns for trait $t$
-


Since the gold standard of drug-disease medical indications is described with Disease Ontology IDs (DOID) [@doi:10.1093/nar/gky1032], we mapped PhenomeXcan traits to the Experimental Factor Ontology [@doi:10.1093/bioinformatics/btq099] using [@url:https://github.com/EBISPOT/EFO-UKB-mappings], and then to DOID.


### Consensus clustering of traits {#sec:methods:clustering}

We performed two preprocessing steps on the S-MultiXcan results before the cluster analysis.
First, we combined results in matrix $\mathbf{M}$ (with $p$-values converted to $z$-scores, as described before) for traits that mapped to the same Experimental Factor Ontology (EFO) term using the Stouffer's method: 

\begin{equation}
\sum w_i M_{ij} / \sqrt{\sum w_i^2}
\end{equation}

where $w_i$ is a weight based on the GWAS sample size for trait $i$, and $M_{ij}$ is the $z$-score for gene $j$.
Second, we divided all $z$-scores for each trait $i$ by their sum to reduce the effect of highly polygenic traits: 

\begin{equation}
M_{ij} / \sum M_{ij}
\end{equation}

Finally, we projected this data matrix using Equation (1), obtaining matrix $\hat{\mathbf{M}}$ with $n$=3,752 traits and $l$=987 latent variables (LVs) as the input of our clustering pipeline.


A partitioning of the estimated matrix M with n traits into k clusters is represented as a label vector π ∈ ℕn.
Consensus clustering approaches consist of two steps: 1) the generation of an ensemble Π with r partitions of the dataset: Π = {π₁, π₂, ..., πᵣ}, and 2) the combination of the ensemble into a consolidated solution defined as:

π* = arg max π̂ Q({|Lⁱ|ϕ(π̂ₗⁱ, πᵢₗⁱ) | i ∈ {1,...,r}}),  {#eq:consensus:obj_func}

where Lⁱ is a set of data indices with known cluster labels for partition i, ϕ: ℕⁿ × ℕⁿ → ℝ is a function that measures the similarity between two partitions, and Q is a measure of central tendency, such as the mean or median.
We used the adjusted Rand index (ARI) (Hubert & Arabie, 1985) for ϕ and the median for Q.
To obtain π*, we define a consensus function Γ: ℕⁿˣʳ → ℕⁿ with Π as the input.
We used consensus functions based on the evidence accumulation clustering (EAC) paradigm (Fred & Jain, 2005), where Π is first transformed into a distance matrix Dᵢⱼ = dᵢⱼ / r, where dᵢⱼ is the number of times traits i and j were grouped in different clusters across all r partitions in Π.
Then, Γ can be any similarity-based clustering algorithm, which is applied on D to derive the final partition π*.


For the ensemble generation step, we utilized various algorithms to construct a highly diverse set of partitions, as depicted in Figure 1, as diversity is a crucial characteristic for ensembles (Li et al., 2016; Shi et al., 2011; Zhang et al., 2014).
We employed three data representations: the raw dataset, its projection onto the top 50 principal components, and the embedding acquired through UMAP (McInnes et al., 2018) with 50 components.
Each of these representations was subjected to five clustering algorithms that encompass a broad spectrum of assumptions regarding the data structure: k-means (Arthur & Vassilvitskii, 2007), spectral clustering (Ng et al., 2001), Gaussian mixture model (GMM), hierarchical clustering, and DBSCAN (Ester et al., 1996). 

For k-means, spectral clustering, and GMM, we defined a range of k values from 2 to approximately 60 (sqrt{n}), generating five partitions for each k with random seeds.
In hierarchical clustering, four partitions were created for each k using common linkage criteria: ward, complete, average, and single.
As for DBSCAN, we explored various ranges for the epsilon (maximum distance between two data points to be considered part of the same neighborhood) and minPts (minimum number of data points in a neighborhood for a data point to be considered a core point) parameters, following the methodology outlined in previous work (Zhang et al., 2018).
Specifically, minPts values ranged from 2 to 125. 

For each data representation (raw, PCA, and UMAP), we identified a suitable range of epsilon values by examining the distribution of the mean distance of the minPts-nearest neighbors across all data points.
To address instances where certain combinations of minPts and epsilon did not yield meaningful partitions (e.g., all points identified as noisy or only one cluster detected), we resampled partitions generated by DBSCAN to ensure an equitable representation of this algorithm in the ensemble.
This process culminated in a final ensemble comprising 4,428 partitions encompassing 3,752 traits. 

*equation_definition*
- k: Number of clusters
- epsilon: Maximum distance between two data points to be considered part of the same neighborhood
- minPts: Minimum number of data points in a neighborhood for a data point to be considered a core point


Finally, spectral clustering was performed on matrix $\mathbf{D}$ to obtain the final consensus partitions.
Matrix $\mathbf{D}$ was initially converted into a similarity matrix using a radial basis function (RBF) kernel $\mathrm{exp}(-\gamma \mathbf{D}^2)$ with four different values for $\gamma$ that were determined empirically as the most effective.
Subsequently, for each value of $k$ ranging from 2 to 60, four consensus partitions were derived, and the one maximizing Equation (@eq:consensus:obj_func) was selected.
The set of 59 solutions was then refined by retaining only those with an ensemble agreement exceeding the 75th percentile (refer to Figure @fig:sup:clustering:agreement), resulting in a total of 15 final consensus partitions as illustrated in Figure @fig:clustering:tree. 

*equation_definition*

Equation (@eq:consensus:obj_func): Maximization objective function for consensus partition selection.

*equation_definition*

The input data in our clustering pipeline undergoes several linear and nonlinear transformations, including Principal Component Analysis (PCA), Uniform Manifold Approximation and Projection (UMAP), and the ensemble transformation using the Ensemble Aggregation Clustering (EAC) paradigm (distance matrix $\mathbf{D}$).

*equation_definition*
- PCA: Principal Component Analysis
- UMAP: Uniform Manifold Approximation and Projection
- EAC: Ensemble Aggregation Clustering

Although consensus clustering has clear advantages for biological data [1], this set of data transformations complicates the interpretation of results.
To circumvent this, we used a supervised learning approach to detect which gene modules/Latent Variables (LVs) are the most important for each cluster of traits (Figure 1b).
Note that we did not use this supervised model for prediction but only to learn which features (LVs) were most discriminative for each cluster.

For this, we used the highest resolution partition ($k$=29, although any could be used) to train a decision tree model using each of the clusters as labels and the projected data $\hat{\mathbf{M}}$ as the training samples.
For each $k$, we built a set of binary labels with the current cluster's traits as the positive class and the rest of the traits as the negative class.
Then, we selected the LV in the root node of the trained model only if its threshold was positive and larger than one standard deviation.

Next, we removed this LV from $\hat{\mathbf{M}$ (regardless of being previously selected or not) and trained the model again.
We repeated this procedure 20 times to extract the top 20 LVs that better discriminate traits in a cluster from the rest.

In [Supplementary Note 2](#sm:clustering:null_sim), we performed several analyses under a null hypothesis of no structure in the data to verify that the clustering results detected by this pipeline were real.


### CRISPR-Cas9 screening {#sec:methods:crispr}

**Cell culture.** HepG2 cells were obtained from ATCC (ATCC® HB-8065™) and were cultured in Eagle's Minimum Essential Medium with L-Glutamine (EMEM, Cat.
112-018-101, Quality Biology) supplemented with 10% Fetal Bovine Serum (FBS, Gibco, Cat.16000-044) and 1% Penicillin-Streptomycin (Pen/Strep, Gibco, Cat.15140-122).
The cells were maintained at 37°C in a humidity-controlled incubator with 5% CO2 and were cultured at a density not exceeding 80% confluency in Collagen-I coated flasks.

*equation_definition*
- EMEM: Eagle's Minimum Essential Medium
- FBS: Fetal Bovine Serum
- Pen/Strep: Penicillin-Streptomycin

---
This revision maintains the technical details and references to specific products used in the cell culture process.
The sentence structure is clearer and more concise.

**Genome-wide lentiviral pooled CRISPR-Cas9 library.** The third generation of the Broad GPP genome-wide Human Brunello CRISPR knockout Pooled library, obtained from Addgene (Cat.
73179-LV) and provided by David Root and John Doench, was utilized for the transduction of HepG2 cells.
This library comprises 76,441 single guide RNAs (sgRNAs) targeting 19,114 genes in the human genome, with an average of 4 sgRNAs per gene.
Each 20 nucleotide sgRNA cassette was inserted into the lentiCRIS-PRv2 backbone between the U6 promoter and the guide RNA scaffold.
The lentiviral vectors encoding Cas9 were employed to deliver the sgRNA cassette-containing plasmids into cells during replication.
Cells that were not successfully transduced were eliminated through puromycin selection.

*equation_definition*
- sgRNA: Single guide RNA
- U6 promoter: RNA polymerase III promoter commonly used to drive expression of small RNAs in mammalian cells
- Cas9: CRISPR-associated protein 9, an RNA-guided DNA endonuclease
- CRISPR: Clustered regularly interspaced short palindromic repeats
- sgRNA cassette: Segment of genetic material containing the sgRNA sequence

Equation (@id): sgRNA = Single guide RNA
Equation (@id): U6 promoter = RNA polymerase III promoter
Equation (@id): Cas9 = CRISPR-associated protein 9
Equation (@id): CRISPR = Clustered regularly interspaced short palindromic repeats
Equation (@id): sgRNA cassette = Segment containing sgRNA sequence

**Lentiviral titer determination.** No-spin lentiviral transduction was utilized for the screen.
Approximately 2.5 million cells were seeded in each well of a Collagen-I coated 6-well plate in the presence of 8 μg/ml polybrene (Millipore Sigma, Cat.
TR-1003 G), along with varying titrated virus volumes (e.g., 0, 50, 100, 200, 250, and 400 μl) assigned to each well.
The final volume was made up to 1.24 ml with EMEM complete media.
Sixteen to eighteen hours post-transduction, the virus/polybrene-containing media was removed, and cells were washed twice with 1x DPBS before fresh EMEM was added.
At 24 hours, cells in each well were trypsinized, diluted (e.g., 1:10), and seeded in pairs of wells in 6-well plates.
At 60 hours post-transduction, the cell media in each well was replaced with fresh EMEM.
One well out of the pair was treated with 2 μg/ml of puromycin (Gibco, Cat.
A1113803).
After 2-5 days of puromycin selection, or if the well with 0 virus treated with puromycin showed no cell survival, cells from both wells (with and without puromycin) were collected and counted for viability.
The Percentage of Infection (PI%) was determined by comparing the cell numbers with and without puromycin selection within each pair.

*equation_definition*
- PI% = (Number of cells with puromycin selection / Number of cells without puromycin selection) x 100%

By applying Poisson's distribution theory, a transduction efficiency (PI%) between 30-50% corresponds to a Multiplicity of Infection (MOI) of approximately 0.35-0.70.
At an MOI close to 0.3, around 25% of cells are infected, with the majority predicted to have only one copy of the virus.
Therefore, a virus volume of 120 μl, which yields 30-40% transduction efficiency, was selected for further large-scale viral transduction.

Lentiviral transduction in HepG2 cells using the Brunello CRISPR knockout pooled library was conducted with the aim of achieving a coverage of at least 500 cells per single-guide RNA (sgRNA).
An MOI between 0.3-0.4 was utilized to ensure that 95% of infected cells received only one viral particle per cell.
Approximately 200 million cells were used to initiate the screen.
The transduction process mirrored the previously described method.
Specifically, 2.5 million cells were plated in each well of 14 6-well plates, with the addition of 8 µg/ml of polybrene.
Subsequently, 120 µl of the virus was added to each experimental well.
After 18 hours post-transduction, the virus/polybrene mix medium was aspirated, and cells in each well were harvested, quantified, and combined into T175 flasks.
At 60 hours post-transduction, puromycin at a concentration of 2 µg/ml was introduced to each flask.
The cell culture media were refreshed every two days with fresh EMEM supplemented with 2 µg/ml puromycin.
Following seven days of puromycin selection, the cells were gathered, pooled, quantified, and replated. 

*equation_definition
MOI = (Number of viral particles)/(Number of target cells)
*equation_definition

*equation_definition
MOI = (Number of viral particles)/(Number of target cells)
*equation_definition

Fluorescent dye staining was conducted 9 days after puromycin selection, with cells divided into two groups.
The Unsorted Control group consisted of 20-30 million cells, which were collected and spun down at 500 x g for 5 minutes at 4°C.
The resulting pellet was then stored at -80°C for subsequent genomic DNA isolation.
The remaining cells, approximately 200 million, were plated in 100 mm dishes and subjected to staining with a fluorescent dye (LipidSpotTM 488, Biotium, Cat.
70065-T).
Specifically, LipidSpot 488 was diluted to a 1:100 ratio with DPBS, and 4 ml of the staining solution was added to each dish, followed by an incubation period at 37°C for 30 minutes.
Cell images were captured using a fluorescent microscope EVOS to detect the GFP signal (Figure 1). 

*equation_definition*

Equation 1: 500 x g = centrifugal force
Equation 2: -80°C = storage temperature
Equation 3: 1:100 = dilution ratio
Equation 4: 4 ml = volume of staining solution
Equation 5: 37°C = incubation temperature

*equation_definition*

**Fluorescence-activated cell sorting (FACS).** Cells were immediately collected into 50ml tubes and spun at 500 x g for 5 minutes at 4°C.
After a wash with DPBS, cell pellets were resuspended with FACS Sorting Buffer (1x DPBS without Ca2+/Mg2+, 2.5mM EDTA, 25mM HEPES, 1% BSA).
The solution was filter sterilized and kept at 4°C, with gentle pipetting to ensure single cells.
The cell solution was then filtered through a cell strainer (Falcon, Cat.
352235) and kept on ice, protected from light.
Collected cells were sorted on FACSJazz using a 100um nozzle for sorting.
Approximately 20% of each GFP-High and GFP-Low population were collected into 15ml tubes.
After sorting, cells were immediately spun down, and the pellets were stored at -80°C for further genomic DNA isolation.

*equation_definition*
- FACS: Fluorescence-activated cell sorting
- DPBS: Dulbecco's Phosphate-Buffered Saline
- EDTA: Ethylenediaminetetraacetic acid
- HEPES: 4-(2-hydroxyethyl)-1-piperazineethanesulfonic acid
- BSA: Bovine Serum Albumin

(*End of equation_definition*)

**Genomic DNA isolation and verification.** Genomic DNA from three conditions (Un-Sorted Control, lentiV2 GFP-High, and lentiV2 GFP-Low) was extracted using the QIAamp DNA Blood Mini Kit (Qiagen, Cat.51104) and assessed for quality and quantity using UV Spectroscopy (Nanodrop).
A total of 80-160 µg of genomic DNA was isolated for each condition.
The presence of the sgRNA cassette and lentiviral-specific transgene in the isolated genomic DNA was confirmed through PCR (Figure 3 in Supplementary Material).

*equation_definition*

- gDNA: Genomic DNA
- sgRNA: Single guide RNA
- PCR: Polymerase Chain Reaction

**Illumina libraries generation and sequencing.** The fragment containing the sgRNA cassette was amplified using P5/P7 primers, as indicated in a previous study by Smith et al.
(2016), and primer sequences were adapted from the Broad Institute protocol (Figure 1).
A stagger sequence of 0-8 nucleotides was included in P5, and an 8-base pair uniquely barcoded sequence was included in P7.
Primers were synthesized by Integrated DNA Technologies (IDT) and each primer was PAGE purified.
32 PCR reactions were set up for each condition.
Each 100 μL PCR reaction consisted of approximately 5 μg of genomic DNA, 5 μL of each 10 μM P5 and P7 primers.
ExTaq DNA Polymerase (TaKaRa, Cat.
RR001A) was used for the amplification of the amplicon.
The PCR thermal cycler parameters were set as follows: an initial denaturation at 95°C for 1 minute, followed by 24 cycles of denaturation at 94°C for 30 seconds, annealing at 52.5°C for 30 seconds, and extension at 72°C for 30 seconds.
A final elongation step was performed at 72°C for 10 minutes.
PCR products of 285-293 base pairs were expected (Figure 2A).
PCR products from the same condition were pooled and purified using SPRIselect beads (Beckman Coulter, Cat.
B23318).
The purified Illumina libraries were quantitated using Qubit, and the quality of the library was assessed on a Bioanalyzer using a High Sensitivity DNA Chip.
A single peak at approximately 285 base pairs was expected (Figure 2B).
The final Illumina library samples were sequenced on a NovaSeq 6000.
The samples were pooled and loaded onto an SP flow cell, along with a 20% PhiX control v3 library spike-in. 

*equation_definition*

- P5: Primer 5
- P7: Primer 7
- gDNA: Genomic DNA
- PCR: Polymerase Chain Reaction
- PAGE: Polyacrylamide Gel Electrophoresis
- IDT: Integrated DNA Technologies


## Data availability

All the main datasets generated in this study are available at [https://doi.org/10.5281/zenodo.8071382](https://doi.org/10.5281/zenodo.8071382) [@doi:10.5281/zenodo.8071382] and the GitHub repository [https://github.com/greenelab/phenoplier](https://github.com/greenelab/phenoplier).

The main input datasets used are TWAS from PhenomeXcan [@doi:10.1126/sciadv.aba2083] for 4,091 traits and from the Electronic Medical Records and Genomics (eMERGE) network phase III [@doi:10.1101/2021.10.21.21265225] for 309 traits; transcriptional responses to small molecule perturbations from LINCS L1000 [@doi:10.1016/j.cell.2017.10.049] that were further preprocessed and mapped to DrugBank IDs from [@doi:10.5281/zenodo.47223]; latent space/gene module models from MultiPLIER [@doi:10.1016/j.cels.2019.04.003].

The data utilized from PhenomeXcan, LINCS L1000, and MultiPLIER are publicly available.
All significant findings reported for the eMERGE and Penn Medicine BioBank (PMBB) phenome-wide TWAS are documented in a previous study (Smith et al., 2021).
The raw individual-level datasets from PMBB cannot be publicly released due to institutional privacy policies.
For inquiries regarding data access, please reach out to the Penn Medicine Biobank (https://pmbb.med.upenn.edu/pmbb/).
The eMERGE network phase III data can be accessed on dbGAP under the accession number phs001584.v2.p2.

*equation_definition: PhenomeXcan - Database integrating GWAS results with tissue-specific gene expression data
*equation_definition: LINCS L1000 - Library of Integrated Network-based Cellular Signatures
*equation_definition: MultiPLIER - Multi-tissue gene regulatory network model

[@doi:10.1101/2021.10.21.21265225] - Smith et al., 2021


## Code availability

The code necessary to reproduce all the analyses in this work is available at [https://doi.org/10.5281/zenodo.8071382](https://doi.org/10.5281/zenodo.8071382) [@doi:10.5281/zenodo.8071382] and the GitHub repository [https://github.com/greenelab/phenoplier](https://github.com/greenelab/phenoplier).

For the CRISPR screening, FlowJo v10.7 and FACS Jazz Software v1.1 were utilized.
Data analysis was performed using Python 3.8 and R 3.6, incorporating various computational packages.
The primary Python packages included Jupyter Lab (2.2), pandas (1.1), matplotlib (3.3), seaborn (0.11), numpy (1.19), scipy (1.5), scikit-learn (0.23), and umap-learn (0.4).
In R, the key packages employed were Bioconductor (3.10), clusterProfiler (3.14), clustree (0.4), and fgsea (1.17).
Additionally, several scripts and notebooks were developed, which have been made available under an open-source license.
Comprehensive documentation detailing all analysis steps was provided.
Furthermore, a Docker image was created to facilitate the utilization of the same runtime environment, along with a demo for quick testing of the methods on authentic data. 

*equation_definition*
Equation (@id): Mathematical equation used in data analysis.
*equation_definition*
